<div id="icemrvis"></div>
<script type="text/javascript">
LABKEY.requiresScript("assay/icemr.js");
LABKEY.requiresScript("assay/tracking/tracking.js");
Ext4.onReady(function(){
    var params = LABKEY.ActionURL.getParameters();
    var filter = LABKEY.Filter.create('PatientID', params.patientId, LABKEY.Filter.getFilterTypeForURLSuffix('eq'));
    LABKEY.icemr.tracking.setInterface(params.schemaName);

    var storeFoldIncreases = function(rows){
        var values = {};
        for(var i = 0; i < rows.length; i++){
            var sample = values[rows[i].SampleID] = {},
                row = rows[i],
                foldIncrease1 = null,
                foldIncrease2 = null,
                foldIncrease3 = null;

            if(row.StartParasitemia1 && row.FinishParasitemia1){
                foldIncrease1 = row.FinishParasitemia1 / row.StartParasitemia1;
            }

            if(row.StartParasitemia2 && row.FinishParasitemia2){
                foldIncrease2 = row.FinishParasitemia2 / row.StartParasitemia2;
            }

            if(row.StartParasitemia3 && row.FinishParasitemia3){
                foldIncrease3 = row.FinishParasitemia3 / row.StartParasitemia3;
            }
            
            sample.FoldIncrease1 = foldIncrease1;
            sample.FoldIncrease2 = foldIncrease2;
            sample.FoldIncrease3 = foldIncrease3;
        }

        return values;
    };

    var createPanel = function(foldIncreases, params, filter){
        var schemaName = params.schemaName;
        var queryName = LABKEY.icemr.tracking.interface.getVisQuery();
        var customButtons = [];
        var cbGroup = Ext4.create('Ext.form.CheckboxGroup', {
            fieldLabel: 'Hover Variables',
            vertical: true,
            columns: 1,
            labelWidth: 125,
            items: [
                {boxLabel: 'Parasitemia', name: 'hoverVariables', inputValue: 'parasitemia', checked: true},
                {boxLabel: 'Split Performed', name: 'hoverVariables', inputValue: 'splitPerformed'},
                {boxLabel: 'Sample Stored', name: 'hoverVariables', inputValue: 'sampleStored'},
                {boxLabel: 'Start Growth Fold Test', name: 'hoverVariables', inputValue: 'startGrowth'},
                {boxLabel: 'End Growth Fold Test', name: 'hoverVariables', inputValue: 'endGrowth'}
            ]
        });

        var ICEMRPanel = Ext4.create('LABKEY.vis.GenericOptionsPanel', {
            items: [cbGroup]
        });

        ICEMRPanel.getPanelOptionValues = function(){
            var cbValue = cbGroup.getValue();
            if(cbValue.hoverVariables instanceof Array){
                return cbValue;
            }
            return {hoverVariables: [cbValue.hoverVariables]};
        };

        var ICEMRWindow = Ext4.create('Ext.window.Window', {
            title: "ICEMR Customization",
            width: 400,
            height: 200,
            items: [ICEMRPanel],
            closeAction: 'hide',
            modal: true,
            buttons: [{text: 'ok', handler: function(){
                ICEMRWindow.close();
//                panel.fireEvent('chartDefinitionChanged');
                panel.chartDefinitionChanged.delay(250);
            }}, {text: 'cancel', handler: function(){
                ICEMRWindow.close();
            }}]
        });

        var ICEMRHandler = function(){
            ICEMRWindow.show();
        };

        var hoverLayers = {
            parasitemia: function(measures){
                var layerConfig = {
                    geom: new LABKEY.vis.Geom.Point(),
                    aes: {
                        shape: function(row){return 'Parasitemia'},
                        hoverText: function(row){
                            var text = row.PatientID.value + "\n";
                            text += "SampleID: " + row.SampleID.value + "\n";
                            text += "Parasitemia(%): " + row.Parasitemia.value + "\n";
                            return text;
                        }
                    }
                };

                return layerConfig;
            },
            splitPerformed: function(measures){
                var layerConfig = {
                    geom: new LABKEY.vis.Geom.Point(),
                    aes: {
                        y: function(row){
                            if(row.Removed && row.Removed.value){
                                return measures.y.acc(row);
                            }
                            return null;
                        },
                        shape: function(row){return 'Split Performed'},
                        hoverText: function(row){
                            var text = row.PatientID.value + "\n";
                            text += "SampleID: " + row.SampleID.value + "\n";
                            text += "Parasitemia(%): " + row.Parasitemia.value + "\n";

                            if(row.Removed && row.Removed.value){
                                text += "Removed(%): " + row.Removed.value + "\n";
                            }

                            return text;
                        }
                    }
                };

                if(measures.color){
                    layerConfig.aes.color = measures.color.acc;
                }

                return layerConfig;
            },
            sampleStored: function(measures){
                var layerConfig = {
                    geom: new LABKEY.vis.Geom.Point(),
                    aes: {
                        y: function(row){
                            if(row.FeezerProIDS && row.FeezerProIDS.value){
                                return measures.y.acc(row);
                            }
                            return null;
                        },
                        shape: function(row){return 'Sample Stored'},
                        hoverText: function(row){
                            var text = row.PatientID.value + "\n";
                            text += "SampleID: " + row.SampleID.value + "\n";
                            text += "Parasitemia(%): " + row.Parasitemia.value + "\n";

                            if(row.FeezerProIDS && row.FeezerProIDS.value){
                                text += "FeezerPro IDs: " + row.FeezerProIDS.value; // This might need to be changed to FreezerProIDS
                            }

                            return text;
                        }
                    }
                };

                if(measures.color){
                    layerConfig.aes.color = measures.color.acc;
                }

                return layerConfig;
            },
            startGrowth: function(measures){
                var layerConfig = {
                    geom: new LABKEY.vis.Geom.Point(),
                    aes: {
                        y: function(row){
                            if(row.GrowthFoldTestInitiated && row.GrowthFoldTestInitiated.value){
                                return measures.y.acc(row);
                            }
                            return null;
                        },
                        shape: function(row){return 'Growth Test Initiated'},
                        hoverText: function(row){
                            var text = row.PatientID.value + "\n";
                            text += "SampleID: " + row.SampleID.value + "\n";
                            text += "Parasitemia(%): " + row.Parasitemia.value + "\n";

                            if(row.GrowthFoldTestInitiated && row.GrowthFoldTestInitiated.value){
                                text += "Test : " + row.GrowthFoldTestInitiated.value;
                            }

                            return text;
                        }
                    }
                };

                if(measures.color){
                    layerConfig.aes.color = measures.color.acc;
                }

                return layerConfig;
            },
            endGrowth: function(measures, foldIncreases){
                var layerConfig = {
                    geom: new LABKEY.vis.Geom.Point(),
                    aes: {
                        y: function(row){
                            if(row.GrowthFoldTestFinished && row.GrowthFoldTestFinished.value){
                                return measures.y.acc(row);
                            }
                            return null;
                        },
                        shape: function(row){return 'Growth Test Finished'},
                        hoverText: function(row){
                            var text = row.PatientID.value + "\n";
                            text += "SampleID: " + row.SampleID.value + "\n";
                            text += "Parasitemia(%): " + row.Parasitemia.value + "\n";

                            if(row.GrowthFoldTestFinished && row.GrowthFoldTestFinished.value){
                                var testNum = row.GrowthFoldTestFinished.value;
                                text += "Test : " + testNum + "\n";
                                
                                if(foldIncreases[row.SampleID.value] && foldIncreases[row.SampleID.value]['FoldIncrease'+testNum]){
                                    text += "Fold Increase: " + foldIncreases[row.SampleID.value]['FoldIncrease'+testNum] + "\n";
                                }
                            }

                            return text;
                        }
                    }
                };

                if(measures.color){
                    layerConfig.aes.color = measures.color.acc;
                }

                return layerConfig;
            }
        };

        var panel = Ext4.create('LABKEY.ext4.GenericChartPanel', {
            height: 600,
            renderTo: 'icemrvis',
            reportId: null,
            renderType: 'ICEMR',
            schemaName: schemaName,
            queryName: queryName,
            canEdit: true,
            hideSave: true,
            allowShare: false,
            isDeveloper: false,
            allowEditMode: true,
            autoColumnXName: 'MeasurementDate',
            autoColumnYName: 'Parasitemia',
            defaultNumberFormat: Ext.util.Format.numberRenderer('0.00'),
            userFilters: [filter],
            customButtons: [Ext4.create('Ext.button.Button', {text: 'ICEMR', handler: ICEMRHandler})],
            getCustomChartOptions: function(scope){
                return {ICEMR: ICEMRPanel.getPanelOptionValues()};
            },
            customRenderTypes: {
                ICEMR: {
                    label: "ICEMR Line Plot",
                    generatePlotConfig: function(scope, chartOptions, measures, renderTo, width, height, data, labels, scales){
                        measures.color = {acc: function(row){return row.SampleID.value}};
                        var layers = [];
                        var groupAcc = function(row){return row.SampleID.value};
                        var pathGeom = new LABKEY.vis.Geom.Path({});
                        var customOptions = chartOptions.customOptions;
                        var pathLayerConfig = {
                            geom: pathGeom,
                            data: data,
                            aes: {
                                group: groupAcc
                            }
                        };

                        layers.push(new LABKEY.vis.Layer(pathLayerConfig));

                        if(customOptions.ICEMR.hoverVariables && customOptions.ICEMR.hoverVariables.length > 0){
                            for(var i = 0; i < customOptions.ICEMR.hoverVariables.length; i++){
                                var hoverVariable = customOptions.ICEMR.hoverVariables[i];
                                if(hoverVariable == 'endGrowth'){
                                    layers.push(new LABKEY.vis.Layer(hoverLayers[hoverVariable](measures, foldIncreases)));
                                } else if(hoverLayers[hoverVariable]){
                                    layers.push(new LABKEY.vis.Layer(hoverLayers[hoverVariable](measures)));
                                }
                            }
                        }

                        scales.x.tickFormat = function(val){
                            if(val !== null && val !== undefined){
                                val = new Date(val);
                                return val.format('M d Y');
                            }
                            return '';
                        };

                        return {
                            renderTo: renderTo,
                            width: width,
                            height: height,
                            labels: labels,
                            scales: scales,
                            data: data,
                            layers: layers
                        };
                    },
                    generateAes: function(scope, chartOptions, measures, pointClickFn){
                        return {
                            x: measures.x.acc,
                            y: measures.y.acc,
                            color: function(row){return row.SampleID.value}
                        };
                    }
                }
            }
        });

        var resize = function() {
            if (panel && panel.doLayout) { panel.doLayout(); }
        };

        Ext4.EventManager.onWindowResize(resize);
    };

    // SelectRows to get fold increase values.
    LABKEY.Query.selectRows({
        schemaName: "Samples",
        queryName: LABKEY.icemr.tracking.interface.getFlasksSampleSetName(),
        filterArray: [filter],
        success: function(results){
            var foldIncreases = storeFoldIncreases(results.rows);
            createPanel(foldIncreases, params, filter);
        },
        failure: function(response){
            createPanel({}, params, filter);
        }
    });
});
</script>