<span style="font-size: large">
<p>Showing data for Experiment ID: <span id='experiment'></span></p>
<p>
Start date: <span id='startDate'></span>
<br>Last upload date: <span id='lastUploadDate'></span>
</p>
</span>
<div id='foldincrease-div'></div>
<div id='numdays-div'></div>
<div id='flasks-div'></div>
<p>
    <a href='javascript:done()' class='labkey-button'>
        <span>Done</span>
    </a>
</p>

<script type="text/javascript">
LABKEY.requiresScript("assay/icemr.js");
LABKEY.requiresScript("assay/tracking/tracking.js");
</script>
<script type="text/javascript">

// for the calculator parameters
var _start = "start";
var _finish = "finish";
var _sampleId = "sampleId";

function done()
{
    var url = LABKEY.ActionURL.buildURL("assay", "assayRuns", LABKEY.ActionURL.getContainer(), LABKEY.ActionURL.getParameters());
    window.location = url;
}

function init()
{
    var params = LABKEY.ActionURL.getParameters();
    //
    // bring back the flasks associated with this run as well as a list of sampleIds
    // sorted by most recent measurement date
    //
    LABKEY.Query.selectRows({
        schemaName : 'assay.Tracking.' + LABKEY.page.assay.name,
        queryName  : 'Data',
        columns :  ['Run/' + LABKEY.icemr.flask.startDate,
                    'Run/' + LABKEY.icemr.tracking.experiment,
                    'Run/' + LABKEY.icemr.tracking.patient,
                    LABKEY.icemr.tracking.sample,
                    LABKEY.icemr.tracking.measurementDate],
        sort : '-'+LABKEY.icemr.tracking.measurementDate,
        filterArray    : [ LABKEY.Filter.create("Run/Rowid", params["Data.Run/RowId~eq"])],
        maxRows : 1,
        success : onSelectSuccess
    });
}

function onSelectSuccess(data, response, options)
{
    //
    // update the header of our page and collect the sampleids of the flasks
    // for which we want to show the calculated results
    //
    if (data && data.rows && data.rows.length > 0)
    {
        var row = data.rows[0];
        Ext4.fly('experiment').update(row['Run/' + LABKEY.icemr.tracking.experiment]);
        Ext4.fly('startDate').update(buildDateString(row['Run/' + LABKEY.icemr.flask.startDate]));
        Ext4.fly('lastUploadDate').update(buildDateString(row[LABKEY.icemr.tracking.measurementDate]));
        this.patientId = row['Run/' + LABKEY.icemr.tracking.patient];
    }

    renderResults();
}

function buildDateString(value)
{
    var d = new Date(value);
    return ( (d.getMonth() + 1) + '/' + d.getDate() + '/' + d.getFullYear());
}

function onVisClick()
{
    window.location = LABKEY.ActionURL.buildURL(
            'icemr',
            "vis",
            LABKEY.ActionURL.getContainer(),
            {
                patientId: patientId,
                edit: true,
                schemaName: 'assay.Tracking.' + LABKEY.page.assay.name
            });
}

function showFoldIncrease()
{
    hideFoldIncrease();
    showCalculator('foldincrease');
}

function showNumDays()
{
    hideNumDays();
    showCalculator('numdays');
}


// calculator must either be 'numdays' or 'foldincrease'
function showCalculator(calculator)
{
    var isNumDays = (calculator == 'numdays');
    var title = isNumDays ? 'Number of Days' : 'Fold-Increase';
    title += ' Calculator';

    items = [];

    // these items are common to both calculators
    items.push({
        xtype : 'label',
        html : '<b>' + title + '</b>',
        margin: '2 0 0 0'
    });

    // since both calculators may be on the page
    // at the same time make the shared fields 'start' and 'finish'
    // unique
    items.push({
        xtype : 'datefield',
        fieldLabel : 'Start Date',
        id : _start + calculator,
        margin: '10 0 2 0'
    });

    items.push({
        xtype : 'datefield',
        fieldLabel : 'Finish Date',
        id : _finish + calculator,
        margin: '5 0 2 0'
    });

    if (calculator == 'foldincrease') {
        items.push({
            xtype : 'textfield',
            fieldLabel : 'Sample ID',
            id : _sampleId,
            margin: '5 0 2 0'
        });
    }

    items.push({
        xtype : 'fieldcontainer',
        layout : {
            type : 'hbox',
            pack : 'center',
            defaultMargins : '5'
        },
        items : [{
            xtype   : 'button',
            text    : 'Submit',
            handler : isNumDays ? renderNumDays : renderFoldIncrease
        },{
            xtype   : 'button',
            text    : 'Cancel',
            handler : isNumDays ? hideNumDays : hideFoldIncrease
        }]
    });

    var fp = Ext4.create('Ext.form.Panel',{
        renderTo: calculator + '-div',
        id      :  calculator + '-form',
        width : 250,
        defaults: {
            validationEvent: false,
            allowBlank : false,
            style : { margin: '2 0 2 0' },
            labelAlign : 'left',
            labelWidth : 75
        },
        method : 'POST',
        enctype :'multipart/form-data',
        border : false,
        stateful : false,
        autoHeight : true,
        frame : true,
        items : items
    });
}

function renderFoldIncrease()
{
    var fields =  Ext4.getCmp('foldincrease-form').getForm().getFields();

    var parameters = {
        start : fields.get(_start + 'foldincrease').getValue(),
        finish : fields.get(_finish + 'foldincrease').getValue(),
        flaskId : fields.get(_sampleId).getValue()
    };

   var qwp = new LABKEY.QueryWebPart({
        title      : 'Fold-Increase Calculator',
        renderTo   : 'foldincrease-div',
        schemaName : 'assay.Tracking.' + LABKEY.page.assay.name,
        queryName  : 'generic_foldincrease',
        parameters :  parameters,
        showPagination : false
    });
}

function renderNumDays()
{
    var fields =  Ext4.getCmp('numdays-form').getForm().getFields();
    var parameters = {
        start : fields.get(_start + 'numdays').getValue(),
        finish : fields.get(_finish + 'numdays').getValue()
    };

    var qwp = new LABKEY.QueryWebPart({
        title      : 'Number of Days Calculator',
        renderTo   : 'numdays-div',
        schemaName : 'assay.Tracking.' + LABKEY.page.assay.name,
        queryName  : 'generic_numdays',
        parameters :  parameters,
        buttonBarPosition : 'none',
        showPagination : false
    });
}

function hideFoldIncrease()
{
    document.getElementById('foldincrease-div').innerHTML = "";
}

function hideNumDays()
{
    document.getElementById('numdays-div').innerHTML = "";
}

function renderResults()
{
    var params = LABKEY.ActionURL.getParameters();

    var foldButton = {
        text    : 'Fold Increase Calculator', items   : [
            {text: 'Show', handler : showFoldIncrease},
            {text: 'Hide', handler : hideFoldIncrease}
            ]
    };

    var dayButton = {
        text    : 'Day Calculator', items   : [
            {text: 'Show', handler : showNumDays},
            {text: 'Hide', handler : hideNumDays}
        ]
    };

    var visButton = {
        text: 'Visualization',
        handler: onVisClick
//        scope: this
    };

    var buttons = [];
    buttons.push(
            LABKEY.QueryWebPart.standardButtons.views,
            LABKEY.QueryWebPart.standardButtons.exportRows,
            LABKEY.QueryWebPart.standardButtons.print,
            foldButton,
            dayButton,
            visButton
    );

    var buttonBar = {};
    buttonBar.position = 'both';
    buttonBar.includeStandardButtons = true;
    buttonBar.items = buttons;

    var qwp = new LABKEY.QueryWebPart({
        renderTo   : 'flasks-div',
        schemaName : 'assay.Tracking.' + LABKEY.page.assay.name,
        queryName  : 'Data',
        buttonBar: buttonBar,
        showPagination : false,
        filters    : [ LABKEY.Filter.create("Run/Rowid", params["Data.Run/RowId~eq"])]
    });
}

/*
* if we want to show the flasks themselves as results instead of
* the actual results then use this function with a list of
* sample/flask IDs
function renderResults(filterValues)
{

    var qwp = new LABKEY.QueryWebPart({
        renderTo   : 'flasks_div',
        schemaName : 'assay.Adaptation.' + LABKEY.icemr.AdaptationAssayResults,
        queryName  : 'adapted_numdays',
        buttonBarPosition: 'none',
        showPagination : false,
        filters    : [ LABKEY.Filter.create(LABKEY.icemr.tracking.sample, filterValues,
            LABKEY.Filter.Types.IN)]
    });

}
 */
Ext4.onReady(function() {
    init();
});
</script>
